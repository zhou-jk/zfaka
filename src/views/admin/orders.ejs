<%- include('../layouts/admin', { 
  currentPage: 'orders',
  pageTitle: '订单列表',
  user: currentUser,
  body: `

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h4 class="mb-0">订单列表</h4>
    <small class="text-muted">管理所有订单</small>
  </div>
  <button type="button" class="btn btn-outline-primary" onclick="exportOrders()">
    <i class="bi bi-download me-2"></i>导出订单
  </button>
</div>

<!-- 搜索筛选 -->
<div class="card table-card mb-4">
  <div class="card-body">
    <form id="searchForm" class="row g-3">
      <div class="col-md-2">
        <input type="text" class="form-control" name="order_no" placeholder="订单号" value="${query?.order_no || ''}">
      </div>
      <div class="col-md-2">
        <input type="text" class="form-control" name="email" placeholder="邮箱" value="${query?.email || ''}">
      </div>
      <div class="col-md-2">
        <select class="form-select" name="product_id">
          <option value="">全部商品</option>
          ${products?.map(p => `
            <option value="${p.id}" ${query?.product_id == p.id ? 'selected' : ''}>${p.name}</option>
          `).join('') || ''}
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select" name="status">
          <option value="">全部状态</option>
          <option value="pending" ${query?.status === 'pending' ? 'selected' : ''}>待支付</option>
          <option value="paid" ${query?.status === 'paid' ? 'selected' : ''}>已支付</option>
          <option value="delivered" ${query?.status === 'delivered' ? 'selected' : ''}>已发货</option>
          <option value="cancelled" ${query?.status === 'cancelled' ? 'selected' : ''}>已取消</option>
          <option value="refunded" ${query?.status === 'refunded' ? 'selected' : ''}>已退款</option>
        </select>
      </div>
      <div class="col-md-2">
        <input type="date" class="form-control" name="start_date" value="${query?.start_date || ''}">
      </div>
      <div class="col-md-2">
        <input type="date" class="form-control" name="end_date" value="${query?.end_date || ''}">
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search me-1"></i>搜索
        </button>
        <a href="/admin/orders" class="btn btn-outline-secondary">重置</a>
      </div>
    </form>
  </div>
</div>

<!-- 统计信息 -->
<div class="row g-3 mb-4">
  <div class="col-auto">
    <div class="bg-white rounded px-3 py-2 border">
      <small class="text-muted">总订单</small>
      <span class="ms-2 fw-bold">${stats?.total || 0}</span>
    </div>
  </div>
  <div class="col-auto">
    <div class="bg-white rounded px-3 py-2 border">
      <small class="text-muted">总金额</small>
      <span class="ms-2 fw-bold text-danger">¥${parseFloat(stats?.amount || 0).toFixed(2)}</span>
    </div>
  </div>
  <div class="col-auto">
    <div class="bg-white rounded px-3 py-2 border">
      <small class="text-warning">待支付</small>
      <span class="ms-2 fw-bold">${stats?.pending || 0}</span>
    </div>
  </div>
  <div class="col-auto">
    <div class="bg-white rounded px-3 py-2 border">
      <small class="text-success">已完成</small>
      <span class="ms-2 fw-bold">${stats?.delivered || 0}</span>
    </div>
  </div>
</div>

<!-- 订单列表 -->
<div class="card table-card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>订单号</th>
            <th>商品名称</th>
            <th>数量</th>
            <th>订单金额</th>
            <th>支付渠道</th>
            <th>状态</th>
            <th>邮箱</th>
            <th>创建时间</th>
            <th width="100">操作</th>
          </tr>
        </thead>
        <tbody>
          ${orders && orders.length > 0 ? orders.map(order => `
            <tr>
              <td><code>${order.order_no}</code></td>
              <td>${order.product_name}</td>
              <td>${order.quantity}</td>
              <td class="text-danger fw-bold">¥${parseFloat(order.total_amount).toFixed(2)}</td>
              <td>
                ${order.pay_channel ? `
                  <span class="badge bg-primary">${order.pay_channel === 'alipay' ? '支付宝' : order.pay_channel}</span>
                ` : '-'}
              </td>
              <td>
                <span class="badge bg-${
                  order.status === 'delivered' ? 'success' :
                  order.status === 'paid' ? 'info' :
                  order.status === 'pending' ? 'warning' :
                  order.status === 'cancelled' ? 'secondary' : 'danger'
                }">
                  ${order.status === 'delivered' ? '已发货' :
                    order.status === 'paid' ? '已支付' :
                    order.status === 'pending' ? '待支付' :
                    order.status === 'cancelled' ? '已取消' : '已退款'}
                </span>
              </td>
              <td>${order.email || '-'}</td>
              <td>${new Date(order.created_at).toLocaleString('zh-CN')}</td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="/admin/orders/${order.id}" class="btn btn-outline-primary" title="详情">
                    <i class="bi bi-eye"></i>
                  </a>
                  ${order.status === 'pending' ? `
                    <button type="button" class="btn btn-outline-secondary" title="取消" onclick="cancelOrder(${order.id})">
                      <i class="bi bi-x-circle"></i>
                    </button>
                  ` : ''}
                </div>
              </td>
            </tr>
          `).join('') : `
            <tr>
              <td colspan="9" class="text-center py-4 text-muted">暂无订单数据</td>
            </tr>
          `}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- 分页 -->
  ${pagination && pagination.totalPages > 1 ? `
  <div class="card-footer bg-white">
    <div class="d-flex justify-content-between align-items-center">
      <small class="text-muted">共 ${pagination.total} 条记录</small>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item ${pagination.page <= 1 ? 'disabled' : ''}">
            <a class="page-link" href="?page=${pagination.page - 1}">上一页</a>
          </li>
          ${Array.from({length: Math.min(5, pagination.totalPages)}, (_, i) => {
            const p = pagination.page <= 3 ? i + 1 : pagination.page - 2 + i;
            if (p > pagination.totalPages) return '';
            return `<li class="page-item ${p === pagination.page ? 'active' : ''}">
              <a class="page-link" href="?page=${p}">${p}</a>
            </li>`;
          }).join('')}
          <li class="page-item ${pagination.page >= pagination.totalPages ? 'disabled' : ''}">
            <a class="page-link" href="?page=${pagination.page + 1}">下一页</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  ` : ''}
</div>

<script>
  async function cancelOrder(id) {
    confirmDelete('确定要取消该订单吗？', async () => {
      try {
        const response = await fetch('/api/admin/orders/' + id + '/cancel', {
          method: 'POST',
        });
        const result = await response.json();
        if (result.code !== 0) throw new Error(result.message);
        showAlert('订单已取消');
        location.reload();
      } catch (error) {
        showAlert(error.message || '操作失败', 'danger');
      }
    });
  }

  function exportOrders() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', '1');
    window.location.href = '/api/admin/orders/export?' + params.toString();
  }
</script>

` }) %>
