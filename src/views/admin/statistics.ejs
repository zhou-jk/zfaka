<% 
  var currentPage = 'statistics';
  var pageTitle = '数据统计';
%>
<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h4 class="mb-0">数据统计</h4>
    <small class="text-muted">查看销售数据和趋势分析</small>
  </div>
  <div class="btn-group">
    <button type="button" class="btn btn-outline-secondary active" onclick="loadData(7)">7天</button>
    <button type="button" class="btn btn-outline-secondary" onclick="loadData(30)">30天</button>
    <button type="button" class="btn btn-outline-secondary" onclick="loadData(90)">90天</button>
  </div>
</div>

<!-- 核心指标 -->
<div class="row g-4 mb-4">
  <div class="col-xl-3 col-md-6">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <div class="text-muted small mb-1">总销售额</div>
            <div class="fs-3 fw-bold text-primary" id="totalSales">¥0.00</div>
            <small class="text-muted" id="salesCompare">较上周期 -</small>
          </div>
          <div class="stat-icon bg-primary bg-opacity-10 text-primary">
            <i class="bi bi-currency-yen"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <div class="text-muted small mb-1">订单数量</div>
            <div class="fs-3 fw-bold text-success" id="totalOrders">0</div>
            <small class="text-muted" id="ordersCompare">较上周期 -</small>
          </div>
          <div class="stat-icon bg-success bg-opacity-10 text-success">
            <i class="bi bi-receipt"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <div class="text-muted small mb-1">卡密销量</div>
            <div class="fs-3 fw-bold text-info" id="totalCards">0</div>
            <small class="text-muted" id="cardsCompare">较上周期 -</small>
          </div>
          <div class="stat-icon bg-info bg-opacity-10 text-info">
            <i class="bi bi-key"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <div class="text-muted small mb-1">平均客单价</div>
            <div class="fs-3 fw-bold text-warning" id="avgOrder">¥0.00</div>
            <small class="text-muted" id="avgCompare">较上周期 -</small>
          </div>
          <div class="stat-icon bg-warning bg-opacity-10 text-warning">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- 销售趋势图 -->
  <div class="col-xl-8">
    <div class="card table-card h-100">
      <div class="card-header">
        <h5 class="mb-0">销售趋势</h5>
      </div>
      <div class="card-body">
        <div style="position: relative; height: 300px;">
          <canvas id="salesChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- 支付渠道占比 -->
  <div class="col-xl-4">
    <div class="card table-card h-100">
      <div class="card-header">
        <h5 class="mb-0">支付渠道分布</h5>
      </div>
      <div class="card-body">
        <div style="position: relative; height: 250px;">
          <canvas id="channelChart"></canvas>
        </div>
        <div id="channelLegend" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-0">
  <!-- 商品销量排行 -->
  <div class="col-xl-6">
    <div class="card table-card">
      <div class="card-header">
        <h5 class="mb-0">商品销量排行 TOP 10</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th width="60">排名</th>
                <th>商品名称</th>
                <th>销量</th>
                <th>销售额</th>
              </tr>
            </thead>
            <tbody id="productRanking">
              <tr>
                <td colspan="4" class="text-center py-4 text-muted">加载中...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 订单状态分布 -->
  <div class="col-xl-6">
    <div class="card table-card">
      <div class="card-header">
        <h5 class="mb-0">订单状态分布</h5>
      </div>
      <div class="card-body">
        <div style="position: relative; height: 200px;">
          <canvas id="statusChart"></canvas>
        </div>
        <div class="row text-center mt-4" id="statusStats">
          <!-- 动态填充 -->
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
  let salesChart = null;
  let channelChart = null;
  let statusChart = null;

  async function loadData(days) {
    // 更新按钮状态
    document.querySelectorAll('.btn-group .btn').forEach((btn, i) => {
      btn.classList.toggle('active', [7, 30, 90][i] === days);
    });

    try {
      // 获取统计数据
      const [summaryRes, trendRes, productRes] = await Promise.all([
        fetch('/api/admin/statistics/summary?days=' + days),
        fetch('/api/admin/statistics/trend?days=' + days),
        fetch('/api/admin/statistics/products?days=' + days),
      ]);

      const summary = (await summaryRes.json()).data;
      const trend = (await trendRes.json()).data;
      const products = (await productRes.json()).data;

      // 更新核心指标
      document.getElementById('totalSales').textContent = '¥' + parseFloat(summary.sales || 0).toFixed(2);
      document.getElementById('totalOrders').textContent = summary.orders || 0;
      document.getElementById('totalCards').textContent = summary.cards || 0;
      document.getElementById('avgOrder').textContent = '¥' + parseFloat(summary.avgOrder || 0).toFixed(2);

      // 更新对比
      updateCompare('salesCompare', summary.salesChange);
      updateCompare('ordersCompare', summary.ordersChange);
      updateCompare('cardsCompare', summary.cardsChange);
      updateCompare('avgCompare', summary.avgChange);

      // 更新销售趋势图
      updateSalesChart(trend);

      // 更新支付渠道图
      updateChannelChart(summary.channels || []);

      // 更新商品排行
      updateProductRanking(products);

      // 更新订单状态分布
      updateStatusChart(summary.statusDist || {});

    } catch (error) {
      console.error('加载统计数据失败:', error);
    }
  }

  function updateCompare(id, change) {
    const el = document.getElementById(id);
    if (change === undefined || change === null) {
      el.textContent = '较上周期 -';
      el.className = 'text-muted';
    } else if (change >= 0) {
      el.innerHTML = '较上周期 <span class="text-success">↑ ' + change.toFixed(1) + '%</span>';
    } else {
      el.innerHTML = '较上周期 <span class="text-danger">↓ ' + Math.abs(change).toFixed(1) + '%</span>';
    }
  }

  function updateSalesChart(data) {
    if (salesChart) salesChart.destroy();

    const ctx = document.getElementById('salesChart').getContext('2d');
    salesChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(function(d) { return d.date; }),
        datasets: [
          {
            label: '销售额',
            data: data.map(function(d) { return d.amount || d.sales || 0; }),
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            fill: true,
            tension: 0.4,
            yAxisID: 'y',
          },
          {
            label: '订单数',
            data: data.map(function(d) { return d.count || d.orders || 0; }),
            borderColor: '#198754',
            backgroundColor: 'transparent',
            borderDash: [5, 5],
            tension: 0.4,
            yAxisID: 'y1',
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: { type: 'linear', display: true, position: 'left', title: { display: true, text: '销售额 (元)' } },
          y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: '订单数' }, grid: { drawOnChartArea: false } },
        },
      }
    });
  }

  function updateChannelChart(channels) {
    if (channelChart) channelChart.destroy();

    const labels = channels.map(c => c.channel === 'alipay' ? '支付宝' : c.channel);
    const values = channels.map(c => c.amount);
    const colors = ['#0d6efd', '#198754', '#ffc107', '#dc3545'];

    const ctx = document.getElementById('channelChart').getContext('2d');
    channelChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: colors.slice(0, labels.length),
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
      }
    });

    // 更新图例
    let legendHtml = '';
    channels.forEach((c, i) => {
      legendHtml += `
        <div class="d-flex justify-content-between mb-2">
          <span><span class="badge me-2" style="background-color: ${colors[i]}">　</span>${c.channel === 'alipay' ? '支付宝' : c.channel}</span>
          <span class="fw-bold">¥${parseFloat(c.amount).toFixed(2)}</span>
        </div>
      `;
    });
    document.getElementById('channelLegend').innerHTML = legendHtml || '<div class="text-muted text-center">暂无数据</div>';
  }

  function updateProductRanking(products) {
    const tbody = document.getElementById('productRanking');
    if (!products || products.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">暂无数据</td></tr>';
      return;
    }

    tbody.innerHTML = products.map((p, i) => `
      <tr>
        <td>
          <span class="badge bg-${i < 3 ? ['danger', 'warning', 'info'][i] : 'secondary'}">${i + 1}</span>
        </td>
        <td>${p.name}</td>
        <td>${p.sales}</td>
        <td class="text-danger">¥${parseFloat(p.amount).toFixed(2)}</td>
      </tr>
    `).join('');
  }

  function updateStatusChart(statusDist) {
    if (statusChart) statusChart.destroy();

    const statusMap = {
      pending: { label: '待支付', color: '#ffc107' },
      paid: { label: '已支付', color: '#17a2b8' },
      delivered: { label: '已发货', color: '#28a745' },
      cancelled: { label: '已取消', color: '#6c757d' },
      refunded: { label: '已退款', color: '#dc3545' },
    };

    const labels = Object.keys(statusDist).map(k => statusMap[k]?.label || k);
    const values = Object.values(statusDist);
    const colors = Object.keys(statusDist).map(k => statusMap[k]?.color || '#6c757d');

    const ctx = document.getElementById('statusChart').getContext('2d');
    statusChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: colors,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } },
      }
    });

    // 更新统计数字
    let statsHtml = '';
    Object.entries(statusDist).forEach(([status, count]) => {
      const info = statusMap[status] || { label: status, color: '#6c757d' };
      statsHtml += `
        <div class="col">
          <div class="fs-4 fw-bold" style="color: ${info.color}">${count}</div>
          <small class="text-muted">${info.label}</small>
        </div>
      `;
    });
    document.getElementById('statusStats').innerHTML = statsHtml || '<div class="col text-muted">暂无数据</div>';
  }

  // 初始加载7天数据
  loadData(7);
</script>
