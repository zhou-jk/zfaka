<% 
  var currentPage = 'cards';
  var pageTitle = '卡密列表';
%>
<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h4 class="mb-0">卡密列表</h4>
    <small class="text-muted">管理所有卡密信息</small>
  </div>
  <a href="/admin/cards/import" class="btn btn-primary">
    <i class="bi bi-cloud-upload me-2"></i>导入卡密
  </a>
</div>

<!-- 搜索筛选 -->
<div class="card table-card mb-4">
  <div class="card-body">
    <form id="searchForm" class="row g-3">
      <div class="col-md-3">
        <input type="text" class="form-control" name="keyword" placeholder="卡密内容/批次号" value="<%= query?.keyword || '' %>">
      </div>
      <div class="col-md-2">
        <select class="form-select" name="product_id">
          <option value="">全部商品</option>
          <% if (products && products.length > 0) { %>
            <% products.forEach(function(p) { %>
              <option value="<%= p.id %>" <%= query?.product_id == p.id ? 'selected' : '' %>><%= p.name %></option>
            <% }); %>
          <% } %>
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select" name="status">
          <option value="">全部状态</option>
          <option value="0" <%= query?.status === '0' || query?.status === 'available' ? 'selected' : '' %>>可用</option>
          <option value="1" <%= query?.status === '1' || query?.status === 'sold' ? 'selected' : '' %>>已售</option>
          <option value="2" <%= query?.status === '2' || query?.status === 'void' ? 'selected' : '' %>>已作废</option>
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search me-1"></i>搜索
        </button>
        <a href="/admin/cards" class="btn btn-outline-secondary">重置</a>
      </div>
    </form>
  </div>
</div>

<!-- 批量操作 -->
<div class="card table-card mb-4 d-none" id="batchActions">
  <div class="card-body py-2">
    <div class="d-flex align-items-center">
      <span class="text-muted me-3">已选择 <span id="selectedCount">0</span> 项</span>
      <button type="button" class="btn btn-sm btn-outline-warning me-2" onclick="batchVoid()">
        <i class="bi bi-x-circle me-1"></i>批量作废
      </button>
      <button type="button" class="btn btn-sm btn-outline-danger me-2" onclick="batchDelete()">
        <i class="bi bi-trash me-1"></i>批量删除
      </button>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
        取消选择
      </button>
    </div>
  </div>
</div>

<!-- 卡密列表 -->
<div class="card table-card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th width="40">
              <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll(this.checked)">
            </th>
            <th width="60">ID</th>
            <th>卡密内容</th>
            <th>所属商品</th>
            <th>批次号</th>
            <th>状态</th>
            <th>关联订单</th>
            <th>创建时间</th>
            <th width="100">操作</th>
          </tr>
        </thead>
        <tbody>
          <% if (cards && cards.length > 0) { %>
            <% cards.forEach(function(card) { %>
              <tr>
                <td>
                  <input type="checkbox" class="form-check-input card-checkbox" value="<%= card.id %>" 
                         onchange="updateSelection()" <%= card.status !== 0 ? 'disabled' : '' %>>
                </td>
                <td><%= card.id %></td>
                <td>
                  <% const cardContent = card.card_code || card.content || ''; %>
                  <code class="user-select-all"><%= cardContent.length > 50 ? cardContent.substring(0, 50) + '...' : cardContent %></code>
                </td>
                <td><%= card.product_name || '-' %></td>
                <td><small class="text-muted"><%= card.batch_no || '-' %></small></td>
                <td>
                  <%# status: 0=可用, 1=已售, 2=作废 %>
                  <span class="badge bg-<%= card.status === 0 ? 'success' : card.status === 1 ? 'info' : 'secondary' %>">
                    <%= card.status === 0 ? '可用' : card.status === 1 ? '已售' : '已作废' %>
                  </span>
                </td>
                <td>
                  <% if (card.order_no) { %>
                    <a href="/admin/orders?order_no=<%= card.order_no %>" class="text-decoration-none">
                      <code><%= card.order_no %></code>
                    </a>
                  <% } else { %>
                    -
                  <% } %>
                </td>
                <td><%= new Date(card.created_at).toLocaleString('zh-CN') %></td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary" title="复制卡密" onclick="copyCard(this)" data-code="<%= (card.card_code || '').replace(/"/g, '&quot;') %>">
                      <i class="bi bi-clipboard"></i>
                    </button>
                    <% if (card.status === 0) { %>
                      <button type="button" class="btn btn-outline-warning" title="作废" onclick="voidCard(<%= card.id %>)">
                        <i class="bi bi-x-circle"></i>
                      </button>
                    <% } %>
                    <button type="button" class="btn btn-outline-danger" title="删除" onclick="deleteCard(<%= card.id %>)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="9" class="text-center py-4 text-muted">暂无卡密数据</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- 分页 -->
  <% if (pagination && pagination.totalPages > 1) { %>
  <div class="card-footer bg-white">
    <div class="d-flex justify-content-between align-items-center">
      <small class="text-muted">共 <%= pagination.total %> 条记录</small>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item <%= pagination.page <= 1 ? 'disabled' : '' %>">
            <a class="page-link" href="?page=<%= pagination.page - 1 %>">上一页</a>
          </li>
          <% for (var i = 0; i < Math.min(5, pagination.totalPages); i++) { 
               var p = pagination.page <= 3 ? i + 1 : pagination.page - 2 + i;
               if (p <= pagination.totalPages) { %>
            <li class="page-item <%= p === pagination.page ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= p %>"><%= p %></a>
            </li>
          <% } } %>
          <li class="page-item <%= pagination.page >= pagination.totalPages ? 'disabled' : '' %>">
            <a class="page-link" href="?page=<%= pagination.page + 1 %>">下一页</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
  <% } %>
</div>

<%- include('partials/footer') %>

<script>
  let selectedIds = [];

  function toggleSelectAll(checked) {
    document.querySelectorAll('.card-checkbox:not(:disabled)').forEach(cb => {
      cb.checked = checked;
    });
    updateSelection();
  }

  function updateSelection() {
    selectedIds = Array.from(document.querySelectorAll('.card-checkbox:checked')).map(cb => parseInt(cb.value));
    document.getElementById('selectedCount').textContent = selectedIds.length;
    document.getElementById('batchActions').classList.toggle('d-none', selectedIds.length === 0);
  }

  function clearSelection() {
    document.querySelectorAll('.card-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateSelection();
  }

  function copyCard(btn) {
    const content = btn.dataset.code || '';
    navigator.clipboard.writeText(content).then(() => {
      showAlert('已复制到剪贴板');
    });
  }

  async function voidCard(id) {
    confirmDelete('确定要作废该卡密吗？作废后无法恢复。', async () => {
      try {
        const response = await fetch('/api/admin/cards/' + id + '/void', {
          method: 'POST',
        });
        const result = await response.json();
        if (result.code !== 0) throw new Error(result.message);
        showAlert('卡密已作废');
        location.reload();
      } catch (error) {
        showAlert(error.message || '操作失败', 'danger');
      }
    });
  }

  async function batchVoid() {
    if (selectedIds.length === 0) return;
    confirmDelete('确定要作废选中的 ' + selectedIds.length + ' 张卡密吗？', async () => {
      try {
        const response = await fetch('/api/admin/cards/batch-void', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: selectedIds }),
        });
        const result = await response.json();
        if (result.code !== 0) throw new Error(result.message);
        showAlert('批量作废成功');
        location.reload();
      } catch (error) {
        showAlert(error.message || '操作失败', 'danger');
      }
    });
  }

  async function deleteCard(id) {
    confirmDelete('确定要删除该卡密吗？删除后无法恢复。', async () => {
      try {
        const response = await fetch('/api/admin/cards/' + id, {
          method: 'DELETE',
        });
        const result = await response.json();
        if (result.code !== 0) throw new Error(result.message);
        showAlert('卡密已删除');
        location.reload();
      } catch (error) {
        showAlert(error.message || '操作失败', 'danger');
      }
    });
  }

  async function batchDelete() {
    if (selectedIds.length === 0) return;
    confirmDelete('确定要删除选中的 ' + selectedIds.length + ' 张卡密吗？', async () => {
      try {
        const response = await fetch('/api/admin/cards/batch-delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: selectedIds }),
        });
        const result = await response.json();
        if (result.code !== 0) throw new Error(result.message);
        showAlert('批量删除成功');
        location.reload();
      } catch (error) {
        showAlert(error.message || '操作失败', 'danger');
      }
    });
  }
</script>
