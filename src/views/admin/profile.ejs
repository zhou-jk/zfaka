<%- include('partials/header', { pageTitle: '个人设置', currentPage: 'profile', currentUser: user }) %>

<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-person me-2"></i>个人信息</h5>
        </div>
        <div class="card-body">
          <div class="text-center mb-4">
            <div class="avatar-circle mx-auto mb-3">
              <i class="bi bi-person-circle" style="font-size: 4rem; color: #6c757d;"></i>
            </div>
            <% if (user?.role === 1) { %>
              <span class="badge bg-danger">超级管理员</span>
            <% } else { %>
              <span class="badge bg-secondary">普通管理员</span>
            <% } %>
          </div>
          
          <form id="profileForm">
            <div class="mb-3">
              <label class="form-label">用户名 <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="username" 
                     value="<%= user?.username || '' %>" required minlength="2" maxlength="50"
                     placeholder="请输入用户名">
            </div>
            
            <div class="mb-3">
              <label class="form-label">邮箱</label>
              <input type="email" class="form-control" name="email" 
                     value="<%= user?.email || '' %>"
                     placeholder="请输入邮箱（可选）">
            </div>
            
            <div class="mb-3">
              <label class="form-label">角色</label>
              <input type="text" class="form-control" disabled
                     value="<%= user?.role === 1 ? '超级管理员' : '普通管理员' %>">
            </div>
            
            <div class="mb-3">
              <label class="form-label">创建时间</label>
              <input type="text" class="form-control" disabled
                     value="<%= user?.created_at ? new Date(user.created_at).toLocaleString('zh-CN') : '-' %>">
            </div>
            
            <div class="d-flex justify-content-between mt-4">
              <a href="/admin/password" class="btn btn-outline-secondary">
                <i class="bi bi-key me-1"></i>修改密码
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-1"></i>保存修改
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
  document.getElementById('profileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = this;
    const btn = form.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    
    const formData = new FormData(form);
    const data = {
      username: formData.get('username'),
      email: formData.get('email') || null
    };
    
    try {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>保存中...';
      
      const response = await fetch('/api/admin/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.code !== 0) {
        throw new Error(result.message);
      }
      
      showAlert('个人信息已更新');
      
      // 刷新页面以更新侧边栏显示的用户名
      setTimeout(function() {
        location.reload();
      }, 1000);
      
    } catch (error) {
      showAlert(error.message || '保存失败', 'danger');
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  });
</script>
