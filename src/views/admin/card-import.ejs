<% 
  var currentPage = 'card-import';
  var pageTitle = '导入卡密';
%>
<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="/admin/cards">卡密列表</a></li>
        <li class="breadcrumb-item active">导入卡密</li>
      </ol>
    </nav>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <div class="card table-card">
      <div class="card-header">
        <h5 class="mb-0">导入卡密</h5>
      </div>
      <div class="card-body">
        <form id="importForm">
          <div class="mb-4">
            <label class="form-label">选择商品 <span class="text-danger">*</span></label>
            <select class="form-select form-select-lg" name="product_id" required>
              <option value="">请选择商品</option>
              <% if (products && products.length > 0) { %>
                <% products.forEach(function(p) { %>
                  <option value="<%= p.id %>"><%= p.name %> (当前库存: <%= p.stock_count || 0 %>)</option>
                <% }); %>
              <% } %>
            </select>
          </div>

          <div class="mb-4">
            <label class="form-label">导入方式</label>
            <ul class="nav nav-pills mb-3">
              <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="pill" href="#textInput">文本输入</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="pill" href="#fileInput">文件上传</a>
              </li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane fade show active" id="textInput">
                <textarea class="form-control font-monospace" name="cards_text" rows="10" 
                          placeholder="请输入卡密内容，每行一个卡密"></textarea>
                <small class="text-muted">每行一个卡密，系统会自动去除空行和重复项</small>
              </div>
              <div class="tab-pane fade" id="fileInput">
                <div class="border rounded p-5 text-center" id="dropZone">
                  <i class="bi bi-cloud-upload display-3 text-muted"></i>
                  <p class="mt-3 mb-2">拖拽文件到此处，或点击选择文件</p>
                  <small class="text-muted">支持 .txt 格式，每行一个卡密</small>
                  <input type="file" id="fileUpload" name="file" accept=".txt" class="d-none">
                </div>
                <div id="fileInfo" class="mt-3 d-none">
                  <div class="alert alert-info d-flex justify-content-between align-items-center mb-0">
                    <span><i class="bi bi-file-text me-2"></i><span id="fileName"></span></span>
                    <button type="button" class="btn btn-sm btn-outline-danger" id="clearFileBtn">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-4">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="skipDuplicate" name="skip_duplicate" checked>
              <label class="form-check-label" for="skipDuplicate">
                跳过重复卡密 (已存在于数据库中的卡密)
              </label>
            </div>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="bi bi-cloud-upload me-2"></i>开始导入
            </button>
            <a href="/admin/cards" class="btn btn-outline-secondary btn-lg">取消</a>
          </div>
        </form>
      </div>
    </div>

    <!-- 导入结果 -->
    <div class="card table-card mt-4 d-none" id="resultCard">
      <div class="card-header">
        <h5 class="mb-0">导入结果</h5>
      </div>
      <div class="card-body">
        <div id="resultContent"></div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card table-card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>导入说明</h5>
      </div>
      <div class="card-body">
        <h6>格式要求</h6>
        <ul class="text-muted small">
          <li>每行一个卡密</li>
          <li>支持文本输入或文件上传</li>
          <li>文件格式：.txt (UTF-8编码)</li>
        </ul>

        <h6 class="mt-4">示例格式</h6>
        <div class="bg-light rounded p-3 font-monospace small">
          CARD-XXXX-XXXX-0001<br>
          CARD-XXXX-XXXX-0002<br>
          CARD-XXXX-XXXX-0003
        </div>

        <h6 class="mt-4">注意事项</h6>
        <ul class="text-muted small">
          <li>空行会被自动忽略</li>
          <li>首尾空格会被自动去除</li>
          <li>可选择是否跳过重复卡密</li>
          <li>导入后库存自动增加</li>
        </ul>
      </div>
    </div>

    <!-- 最近导入记录 -->
    <% if (recentBatches && recentBatches.length > 0) { %>
    <div class="card table-card mt-4">
      <div class="card-header">
        <h5 class="mb-0">最近导入记录</h5>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush">
          <% recentBatches.forEach(function(batch) { %>
            <div class="list-group-item">
              <div class="d-flex justify-content-between">
                <small class="text-muted"><%= batch.batch_no || batch.id %></small>
                <span class="badge bg-success"><%= batch.count %> 张</span>
              </div>
              <div class="small"><%= batch.product_name %></div>
              <small class="text-muted"><%= new Date(batch.created_at).toLocaleString('zh-CN') %></small>
            </div>
          <% }); %>
        </div>
      </div>
    </div>
    <% } %>
  </div>
</div>

<%- include('partials/footer') %>

<script>
  const dropZone = document.getElementById('dropZone');
  const fileUpload = document.getElementById('fileUpload');
  let selectedFile = null;

  // 点击选择文件
  dropZone.addEventListener('click', () => fileUpload.click());

  // 拖拽上传
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('bg-light');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('bg-light');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('bg-light');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFile(files[0]);
    }
  });

  fileUpload.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      handleFile(e.target.files[0]);
    }
  });

  function handleFile(file) {
    if (!file.name.endsWith('.txt')) {
      showAlert('请上传 .txt 格式的文件', 'danger');
      return;
    }
    selectedFile = file;
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileInfo').classList.remove('d-none');
  }

  function clearFile() {
    selectedFile = null;
    fileUpload.value = '';
    document.getElementById('fileInfo').classList.add('d-none');
  }

  // 绑定清除文件按钮
  document.getElementById('clearFileBtn').addEventListener('click', function() {
    clearFile();
  });

  document.getElementById('importForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const productId = this.querySelector('[name="product_id"]').value;
    if (!productId) {
      showAlert('请选择商品', 'warning');
      return;
    }

    const cardsText = this.querySelector('[name="cards_text"]').value.trim();
    const activeTab = document.querySelector('.tab-pane.active').id;

    if (activeTab === 'textInput' && !cardsText) {
      showAlert('请输入卡密内容', 'warning');
      return;
    }

    if (activeTab === 'fileInput' && !selectedFile) {
      showAlert('请选择要上传的文件', 'warning');
      return;
    }

    const btn = this.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    
    try {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>导入中...';

      const formData = new FormData();
      formData.append('product_id', productId);
      formData.append('skip_duplicate', this.querySelector('[name="skip_duplicate"]').checked ? '1' : '0');

      if (activeTab === 'textInput') {
        formData.append('cards_text', cardsText);
      } else {
        formData.append('file', selectedFile);
      }

      const response = await fetch('/api/admin/cards/import', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (result.code !== 0) {
        throw new Error(result.message);
      }

      // 显示结果
      const data = result.data;
      document.getElementById('resultContent').innerHTML = `
        <div class="alert alert-success">
          <i class="bi bi-check-circle me-2"></i>导入完成
        </div>
        <div class="row text-center">
          <div class="col-4">
            <div class="fs-3 fw-bold text-primary">${data.total}</div>
            <small class="text-muted">总数量</small>
          </div>
          <div class="col-4">
            <div class="fs-3 fw-bold text-success">${data.imported}</div>
            <small class="text-muted">成功导入</small>
          </div>
          <div class="col-4">
            <div class="fs-3 fw-bold text-warning">${data.duplicates}</div>
            <small class="text-muted">重复跳过</small>
          </div>
        </div>
        <div class="mt-3">
          <small class="text-muted">批次号: ${data.batch_no || data.batch_id}</small>
        </div>
        <div class="mt-3">
          <a href="/admin/cards?batch_id=${data.batch_id || data.batch_no}" class="btn btn-primary">
            <i class="bi bi-eye me-2"></i>查看导入的卡密
          </a>
        </div>
      `;
      document.getElementById('resultCard').classList.remove('d-none');

      // 清空表单
      this.querySelector('[name="cards_text"]').value = '';
      clearFile();

    } catch (error) {
      showAlert(error.message || '导入失败', 'danger');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  });
</script>
