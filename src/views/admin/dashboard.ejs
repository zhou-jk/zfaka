<% 
  var currentPage = 'dashboard';
  var pageTitle = '控制台';
%>
<%- include('partials/header') %>

<!-- 统计卡片 -->
<div class="row g-4 mb-4">
  <div class="col-xl-3 col-md-6">
    <div class="card stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="stat-icon bg-primary bg-opacity-10 text-primary">
          <i class="bi bi-currency-yen"></i>
        </div>
        <div class="ms-3">
          <div class="text-muted small">今日销售额</div>
          <div class="fs-4 fw-bold">¥<%= (stats.today?.sales || 0).toFixed(2) %></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6">
    <div class="card stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="stat-icon bg-success bg-opacity-10 text-success">
          <i class="bi bi-receipt"></i>
        </div>
        <div class="ms-3">
          <div class="text-muted small">今日订单</div>
          <div class="fs-4 fw-bold"><%= stats.today?.orders || 0 %> 单</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6">
    <div class="card stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="stat-icon bg-warning bg-opacity-10 text-warning">
          <i class="bi bi-box-seam"></i>
        </div>
        <div class="ms-3">
          <div class="text-muted small">商品数量</div>
          <div class="fs-4 fw-bold"><%= stats.products || 0 %> 个</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6">
    <div class="card stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="stat-icon bg-info bg-opacity-10 text-info">
          <i class="bi bi-key"></i>
        </div>
        <div class="ms-3">
          <div class="text-muted small">卡密库存</div>
          <div class="fs-4 fw-bold"><%= stats.cards || 0 %> 张</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- 销售趋势 -->
  <div class="col-xl-8">
    <div class="card table-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">销售趋势</h5>
        <div class="btn-group btn-group-sm">
          <button type="button" class="btn btn-outline-secondary active" onclick="loadChart(7)">7天</button>
          <button type="button" class="btn btn-outline-secondary" onclick="loadChart(30)">30天</button>
        </div>
      </div>
      <div class="card-body">
        <canvas id="salesChart" height="300"></canvas>
      </div>
    </div>
  </div>

  <!-- 快捷操作 -->
  <div class="col-xl-4">
    <div class="card table-card">
      <div class="card-header">
        <h5 class="mb-0">快捷操作</h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="/admin/products/add" class="btn btn-outline-primary">
            <i class="bi bi-plus-lg me-2"></i>添加商品
          </a>
          <a href="/admin/cards/import" class="btn btn-outline-success">
            <i class="bi bi-cloud-upload me-2"></i>导入卡密
          </a>
          <a href="/admin/orders" class="btn btn-outline-info">
            <i class="bi bi-receipt me-2"></i>查看订单
          </a>
          <a href="/admin/statistics" class="btn btn-outline-warning">
            <i class="bi bi-graph-up me-2"></i>数据统计
          </a>
        </div>
      </div>
    </div>

    <!-- 系统信息 -->
    <div class="card table-card mt-4">
      <div class="card-header">
        <h5 class="mb-0">系统信息</h5>
      </div>
      <div class="card-body">
        <table class="table table-borderless table-sm mb-0">
          <tr>
            <td class="text-muted">系统版本</td>
            <td class="text-end">v1.0.0</td>
          </tr>
          <tr>
            <td class="text-muted">Node.js版本</td>
            <td class="text-end"><%= process.version %></td>
          </tr>
          <tr>
            <td class="text-muted">运行环境</td>
            <td class="text-end"><%= process.env.NODE_ENV || 'development' %></td>
          </tr>
          <tr>
            <td class="text-muted">服务器时间</td>
            <td class="text-end"><%= new Date().toLocaleString('zh-CN') %></td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- 商品销量排行 -->
<div class="card table-card mt-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">商品销量排行（近30天）</h5>
    <a href="/admin/statistics" class="btn btn-sm btn-outline-primary">查看更多</a>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>排名</th>
            <th>商品名称</th>
            <th>销量</th>
            <th>销售额</th>
          </tr>
        </thead>
        <tbody>
          <% if (ranking && ranking.length > 0) { %>
            <% ranking.forEach(function(item, index) { %>
              <tr>
                <td>
                  <% if (index < 3) { %>
                    <span class="badge bg-<%= index === 0 ? 'danger' : (index === 1 ? 'warning' : 'info') %>"><%= index + 1 %></span>
                  <% } else { %>
                    <span class="text-muted"><%= index + 1 %></span>
                  <% } %>
                </td>
                <td><%= item.product_name %></td>
                <td><%= item.total_quantity %> 件</td>
                <td class="text-danger">¥<%= parseFloat(item.total_sales || 0).toFixed(2) %></td>
              </tr>
            <% }); %>
          <% } else { %>
            <tr>
              <td colspan="4" class="text-center py-4 text-muted">暂无销量数据</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
  let salesChart = null;
  
  // 初始化趋势数据
  const initialTrend = <%- JSON.stringify(trend || []) %>;

  function renderChart(data) {
    const labels = data.map(d => d.date);
    const sales = data.map(d => parseFloat(d.sales || 0));
    const orders = data.map(d => parseInt(d.orders || 0));

    if (salesChart) salesChart.destroy();

    const ctx = document.getElementById('salesChart').getContext('2d');
    salesChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: '销售额',
            data: sales,
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            fill: true,
            tension: 0.4,
            yAxisID: 'y',
          },
          {
            label: '订单数',
            data: orders,
            borderColor: '#198754',
            backgroundColor: 'transparent',
            borderDash: [5, 5],
            tension: 0.4,
            yAxisID: 'y1',
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: { display: true, text: '销售额 (元)' },
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: { display: true, text: '订单数' },
            grid: { drawOnChartArea: false },
          },
        },
      }
    });
  }

  async function loadChart(days) {
    // 更新按钮状态
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.textContent.includes(days + '天')) {
        btn.classList.add('active');
      }
    });

    try {
      const response = await fetch('/admin/api/statistics/trend?days=' + days);
      const result = await response.json();
      
      if (result.code !== 0) throw new Error(result.message);
      renderChart(result.data);
    } catch (error) {
      console.error('加载图表失败:', error);
      showAlert('加载图表失败: ' + error.message, 'danger');
    }
  }

  // 初始加载
  if (initialTrend.length > 0) {
    renderChart(initialTrend);
  } else {
    loadChart(7);
  }
</script>

<%- include('partials/footer') %>
