<%- include('../layouts/admin', { 
  currentPage: 'products',
  pageTitle: '商品列表',
  user: currentUser,
  body: `

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h4 class="mb-0">商品列表</h4>
    <small class="text-muted">管理所有商品信息</small>
  </div>
  <a href="/admin/products/add" class="btn btn-primary">
    <i class="bi bi-plus-lg me-2"></i>添加商品
  </a>
</div>

<!-- 搜索筛选 -->
<div class="card table-card mb-4">
  <div class="card-body">
    <form id="searchForm" class="row g-3">
      <div class="col-md-3">
        <input type="text" class="form-control" name="keyword" placeholder="商品名称/ID" value="${query?.keyword || ''}">
      </div>
      <div class="col-md-2">
        <select class="form-select" name="category_id">
          <option value="">全部分类</option>
          ${categories?.map(c => `
            <option value="${c.id}" ${query?.category_id == c.id ? 'selected' : ''}>${c.name}</option>
          `).join('') || ''}
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select" name="status">
          <option value="">全部状态</option>
          <option value="1" ${query?.status === '1' ? 'selected' : ''}>上架</option>
          <option value="0" ${query?.status === '0' ? 'selected' : ''}>下架</option>
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-search me-1"></i>搜索
        </button>
        <a href="/admin/products" class="btn btn-outline-secondary">重置</a>
      </div>
    </form>
  </div>
</div>

<!-- 商品列表 -->
<div class="card table-card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th width="60">ID</th>
            <th width="80">图片</th>
            <th>商品名称</th>
            <th>分类</th>
            <th>价格</th>
            <th>库存</th>
            <th>销量</th>
            <th>状态</th>
            <th>标签</th>
            <th width="150">操作</th>
          </tr>
        </thead>
        <tbody>
          ${products && products.length > 0 ? products.map(p => `
            <tr>
              <td>${p.id}</td>
              <td>
                ${p.image ? `
                  <img src="${p.image}" class="rounded" width="50" height="50" style="object-fit: cover;">
                ` : `
                  <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="bi bi-image text-muted"></i>
                  </div>
                `}
              </td>
              <td>
                <div class="fw-medium">${p.name}</div>
                <small class="text-muted">${p.description ? p.description.substring(0, 30) + '...' : ''}</small>
              </td>
              <td><span class="badge bg-secondary">${p.category_name || '未分类'}</span></td>
              <td class="text-danger fw-bold">¥${parseFloat(p.price).toFixed(2)}</td>
              <td>
                <span class="${p.stock_count > 0 ? 'text-success' : 'text-danger'}">
                  ${p.stock_count || 0}
                </span>
              </td>
              <td>${p.sales_count || 0}</td>
              <td>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" ${p.status ? 'checked' : ''} 
                         onchange="toggleStatus(${p.id}, this.checked)">
                </div>
              </td>
              <td>
                ${p.is_hot ? '<span class="badge bg-danger me-1">热门</span>' : ''}
                ${p.is_recommend ? '<span class="badge bg-warning">推荐</span>' : ''}
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="/admin/products/${p.id}/edit" class="btn btn-outline-primary" title="编辑">
                    <i class="bi bi-pencil"></i>
                  </a>
                  <a href="/admin/cards?product_id=${p.id}" class="btn btn-outline-info" title="卡密">
                    <i class="bi bi-key"></i>
                  </a>
                  <button type="button" class="btn btn-outline-danger" title="删除" 
                          onclick="deleteProduct(${p.id})">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `).join('') : `
            <tr>
              <td colspan="10" class="text-center py-4 text-muted">暂无商品数据</td>
            </tr>
          `}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- 分页 -->
  ${pagination && pagination.totalPages > 1 ? `
  <div class="card-footer bg-white">
    <nav>
      <ul class="pagination pagination-sm mb-0 justify-content-center">
        <li class="page-item ${pagination.page <= 1 ? 'disabled' : ''}">
          <a class="page-link" href="?page=${pagination.page - 1}">上一页</a>
        </li>
        ${Array.from({length: Math.min(5, pagination.totalPages)}, (_, i) => {
          const p = pagination.page <= 3 ? i + 1 : pagination.page - 2 + i;
          if (p > pagination.totalPages) return '';
          return `<li class="page-item ${p === pagination.page ? 'active' : ''}">
            <a class="page-link" href="?page=${p}">${p}</a>
          </li>`;
        }).join('')}
        <li class="page-item ${pagination.page >= pagination.totalPages ? 'disabled' : ''}">
          <a class="page-link" href="?page=${pagination.page + 1}">下一页</a>
        </li>
      </ul>
    </nav>
  </div>
  ` : ''}
</div>

<script>
  async function toggleStatus(id, status) {
    try {
      const response = await fetch('/api/admin/products/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: status ? 1 : 0 }),
      });
      const result = await response.json();
      if (result.code !== 0) throw new Error(result.message);
      showAlert(status ? '商品已上架' : '商品已下架');
    } catch (error) {
      showAlert(error.message || '操作失败', 'danger');
      location.reload();
    }
  }

  async function deleteProduct(id) {
    confirmDelete('确定要删除该商品吗？删除后无法恢复。', async () => {
      try {
        const response = await fetch('/api/admin/products/' + id, {
          method: 'DELETE',
        });
        const result = await response.json();
        if (result.code !== 0) throw new Error(result.message);
        showAlert('商品已删除');
        location.reload();
      } catch (error) {
        showAlert(error.message || '删除失败', 'danger');
      }
    });
  }
</script>

` }) %>
