<%- include('../layouts/main', { body: `

<div class="container py-4">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">首页</a></li>
      <li class="breadcrumb-item active">${product.name}</li>
    </ol>
  </nav>

  <div class="row">
    <!-- 商品图片 -->
    <div class="col-lg-5 mb-4">
      <div class="card">
        ${product.image ? `
          <img src="${product.image}" class="card-img-top" alt="${product.name}" style="max-height: 400px; object-fit: contain;">
        ` : `
          <div class="card-img-top d-flex align-items-center justify-content-center bg-light" style="height: 300px;">
            <i class="bi bi-image display-1 text-muted"></i>
          </div>
        `}
      </div>
    </div>

    <!-- 商品信息 -->
    <div class="col-lg-7">
      <div class="card">
        <div class="card-body">
          <div class="mb-3">
            ${product.is_hot ? '<span class="badge bg-danger me-1">热门</span>' : ''}
            ${product.is_recommend ? '<span class="badge bg-warning">推荐</span>' : ''}
          </div>
          
          <h2 class="card-title mb-3">${product.name}</h2>
          
          <p class="text-muted mb-4">${product.description || '暂无描述'}</p>
          
          <div class="bg-light rounded p-3 mb-4">
            <div class="row align-items-center">
              <div class="col">
                <span class="text-muted">价格</span>
                <div class="d-flex align-items-baseline">
                  <span class="text-danger fs-2 fw-bold">¥${parseFloat(product.price).toFixed(2)}</span>
                  ${product.original_price ? `
                    <span class="text-muted text-decoration-line-through ms-2">¥${parseFloat(product.original_price).toFixed(2)}</span>
                  ` : ''}
                </div>
              </div>
              <div class="col-auto">
                <span class="text-muted">库存</span>
                <div class="fs-4 ${product.stock_count > 0 ? 'text-success' : 'text-danger'}">
                  ${product.stock_count > 0 ? product.stock_count + ' 件' : '暂时缺货'}
                </div>
              </div>
            </div>
          </div>

          <!-- 购买表单 -->
          <form id="orderForm" ${product.stock_count <= 0 ? 'style="opacity: 0.5; pointer-events: none;"' : ''}>
            <input type="hidden" name="product_id" value="${product.id}">
            
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label">购买数量</label>
                <div class="input-group">
                  <button type="button" class="btn btn-outline-secondary" id="decreaseQty">
                    <i class="bi bi-dash"></i>
                  </button>
                  <input type="number" class="form-control text-center" name="quantity" id="quantity" 
                         value="1" min="${product.min_quantity}" max="${Math.min(product.max_quantity, product.stock_count)}">
                  <button type="button" class="btn btn-outline-secondary" id="increaseQty">
                    <i class="bi bi-plus"></i>
                  </button>
                </div>
                <small class="text-muted">单次购买 ${product.min_quantity} - ${product.max_quantity} 件</small>
              </div>
              <div class="col-md-6">
                <label class="form-label">邮箱 (可选)</label>
                <input type="email" class="form-control" name="email" placeholder="用于接收订单通知">
                <small class="text-muted">填写后可通过邮箱查询订单</small>
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">
              <div>
                <span class="text-muted">合计：</span>
                <span class="text-danger fs-3 fw-bold" id="totalAmount">¥${parseFloat(product.price).toFixed(2)}</span>
              </div>
              <button type="submit" class="btn btn-primary btn-lg px-5" ${product.stock_count <= 0 ? 'disabled' : ''}>
                <i class="bi bi-cart-check me-2"></i>立即购买
              </button>
            </div>
          </form>

          <div class="border-top pt-3">
            <small class="text-muted">
              <i class="bi bi-shield-check me-1"></i>支付成功后系统自动发货
              <i class="bi bi-clock ms-3 me-1"></i>7x24小时自助购买
            </small>
          </div>
        </div>
      </div>

      <!-- 商品详情 -->
      ${product.content ? `
      <div class="card mt-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">商品详情</h5>
        </div>
        <div class="card-body">
          ${product.content}
        </div>
      </div>
      ` : ''}
    </div>
  </div>
</div>

<!-- 支付选择弹窗 -->
<div class="modal fade" id="payModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">选择支付方式</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <div class="text-muted">订单金额</div>
          <div class="text-danger fs-2 fw-bold" id="payAmount">¥0.00</div>
        </div>
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-outline-primary btn-lg" id="payAlipayBtn">
            <i class="bi bi-alipay me-2"></i>支付宝支付
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-muted">订单号：<span id="orderNoDisplay"></span></small>
      </div>
    </div>
  </div>
</div>

<script>
  const price = ${product.price};
  const maxQty = ${Math.min(product.max_quantity, product.stock_count)};
  const minQty = ${product.min_quantity};
  let currentOrder = null;

  function changeQuantity(delta) {
    const input = document.getElementById('quantity');
    let value = parseInt(input.value) + delta;
    value = Math.max(minQty, Math.min(maxQty, value));
    input.value = value;
    updateTotal();
  }

  function updateTotal() {
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    const total = (price * quantity).toFixed(2);
    document.getElementById('totalAmount').textContent = '¥' + total;
  }

  // 绑定数量按钮事件
  document.getElementById('decreaseQty').addEventListener('click', function() {
    changeQuantity(-1);
  });
  document.getElementById('increaseQty').addEventListener('click', function() {
    changeQuantity(1);
  });
  document.getElementById('quantity').addEventListener('input', updateTotal);

  // 支付宝支付按钮
  document.getElementById('payAlipayBtn').addEventListener('click', function() {
    pay('alipay');
  });

  // 提交订单
  document.getElementById('orderForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
      product_id: parseInt(formData.get('product_id')),
      quantity: parseInt(formData.get('quantity')),
      email: formData.get('email') || undefined,
    };

    try {
      const btn = this.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>创建订单中...';

      const response = await fetch('/api/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (result.code !== 0) {
        throw new Error(result.message);
      }

      currentOrder = result.data.order;
      document.getElementById('payAmount').textContent = '¥' + currentOrder.total_amount.toFixed(2);
      document.getElementById('orderNoDisplay').textContent = currentOrder.order_no;
      
      new bootstrap.Modal(document.getElementById('payModal')).show();

    } catch (error) {
      alert(error.message || '订单创建失败');
    } finally {
      const btn = this.querySelector('button[type="submit"]');
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-cart-check me-2"></i>立即购买';
    }
  });

  // 发起支付
  async function pay(channel) {
    if (!currentOrder) return;

    try {
      const response = await fetch('/api/orders/' + currentOrder.order_no + '/pay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pay_channel: channel }),
      });

      const result = await response.json();

      if (result.code !== 0) {
        throw new Error(result.message);
      }

      // 跳转到支付页面
      if (result.data.payment.payUrl) {
        window.location.href = result.data.payment.payUrl;
      }

    } catch (error) {
      alert(error.message || '支付发起失败');
    }
  }
</script>

` }) %>
